
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://defra.github.io/ffc-development-guide/development-patterns/authentication/defra-identity/">
      
      
        <link rel="prev" href="../../cache/">
      
      
        <link rel="next" href="../entra/">
      
      
      <link rel="icon" href="../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Defra Identity - FCP Development Guide</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#defra-identity" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="FCP Development Guide" class="md-header__button md-logo" aria-label="FCP Development Guide" data-md-component="logo">
      
  <img src="../../../img/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FCP Development Guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Defra Identity
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/DEFRA/ffc-development-guide" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="FCP Development Guide" class="md-nav__button md-logo" aria-label="FCP Development Guide" data-md-component="logo">
      
  <img src="../../../img/favicon.png" alt="logo">

    </a>
    FCP Development Guide
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DEFRA/ffc-development-guide" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/platform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Understand the Platform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/cicd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Understand CI/CD approach
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/arrange-access/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Arrange access to resources
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Setup your local development environment
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Setup your local development environment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Windows
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Windows
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-wsl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Windows Subsystem for Linux (WSL)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/wsl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Update WSL configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/setup-sudoers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Add user to sudoers file
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Mac
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Mac
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/setup-macos-command-line-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup command line tools
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/mac-setup-scripts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mac setup Scripts
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Common
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Common
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-docker-desktop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Docker Desktop
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-vs-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Visual Studio Code
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-neostandard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install neostandard
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-node-version-manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Node Version Manager (NVM)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-dotnet-sdk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install .NET SDK
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-sonarqube/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install SonarQube
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-detect-secrets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Detect Secrets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-kubectl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install kubectl
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-kubelogin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install kubelogin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-helm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Helm
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-azure-cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Azure CLI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-snyk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Snyk CLI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-github/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install GitHub CLI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/install-openvpn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install OpenVPN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../local-development-setup/sign-commits/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup commit signing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Create a new service
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Create a new service
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../create-a-new-service/choose-a-technology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Choose a technology
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../create-a-new-service/github/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create a source code repository
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../create-a-new-service/conventions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Repository conventions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../create-a-new-service/jenkins/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup a Jenkins CI pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../create-a-new-service/ado/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup an Azure DevOps CD pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../create-a-new-service/deploy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deploy a service
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development patterns
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Development patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Containers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helm-charts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Helm charts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../probes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Health probes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../identity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Identity
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration and secrets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../events-and-messages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Events and messages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../storage.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../databases/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Databases
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Caching
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logging.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_11" checked>
        
          
          <label class="md-nav__link" for="__nav_5_11" id="__nav_5_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Authentication
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_11">
            <span class="md-nav__icon md-icon"></span>
            Authentication
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Defra Identity
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Defra Identity
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#credentials" class="md-nav__link">
    <span class="md-ellipsis">
      Credentials
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#permissions" class="md-nav__link">
    <span class="md-ellipsis">
      Permissions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#login-page" class="md-nav__link">
    <span class="md-ellipsis">
      Login page
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#organisation-picker" class="md-nav__link">
    <span class="md-ellipsis">
      Organisation picker
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authorisation-code-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Authorisation Code Flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#single-sign-on" class="md-nav__link">
    <span class="md-ellipsis">
      Single Sign on
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-defra-identity-in-an-fcp-service" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing Defra Identity in an FCP service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing Defra Identity in an FCP service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-repository" class="md-nav__link">
    <span class="md-ellipsis">
      Example repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#onboard-with-defra-identity" class="md-nav__link">
    <span class="md-ellipsis">
      Onboard with Defra Identity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decide-session-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Decide session setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#understand-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Understand endpoints
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-login" class="md-nav__link">
    <span class="md-ellipsis">
      Implement login
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implement login">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state" class="md-nav__link">
    <span class="md-ellipsis">
      State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nonce-initialisation-vector" class="md-nav__link">
    <span class="md-ellipsis">
      Nonce / Initialisation Vector
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handle-callback-from-defra-identity" class="md-nav__link">
    <span class="md-ellipsis">
      Handle callback from Defra Identity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-user-to-specific-location-after-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Return user to specific location after authentication
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Return user to specific location after authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-authentication-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Set up authentication strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#project-routes" class="md-nav__link">
    <span class="md-ellipsis">
      Project routes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#role-based-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Role based authentication
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Role based authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#azure-api-management" class="md-nav__link">
    <span class="md-ellipsis">
      Azure API Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parsing-siti-agri-response" class="md-nav__link">
    <span class="md-ellipsis">
      Parsing Siti Agri response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updating-credentials" class="md-nav__link">
    <span class="md-ellipsis">
      Updating credentials
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protecting-routes" class="md-nav__link">
    <span class="md-ellipsis">
      Protecting routes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refresh-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      Refresh tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-out" class="md-nav__link">
    <span class="md-ellipsis">
      Sign out
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-service-user-journeys" class="md-nav__link">
    <span class="md-ellipsis">
      Cross service user journeys
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../entra/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Entra
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../analytics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Analytics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../git-secrets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Git secrets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../shared-assets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shared assets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../version-control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Version control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../documentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Documentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code-review/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code review
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Release notes
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Testing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/unit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Integration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/contract/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contract
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Performance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/accessibility/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Accessibility
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/compatibility/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compatibility
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/code-analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/acceptance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Acceptance
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#credentials" class="md-nav__link">
    <span class="md-ellipsis">
      Credentials
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#permissions" class="md-nav__link">
    <span class="md-ellipsis">
      Permissions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#login-page" class="md-nav__link">
    <span class="md-ellipsis">
      Login page
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#organisation-picker" class="md-nav__link">
    <span class="md-ellipsis">
      Organisation picker
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authorisation-code-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Authorisation Code Flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#single-sign-on" class="md-nav__link">
    <span class="md-ellipsis">
      Single Sign on
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-defra-identity-in-an-fcp-service" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing Defra Identity in an FCP service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing Defra Identity in an FCP service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-repository" class="md-nav__link">
    <span class="md-ellipsis">
      Example repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#onboard-with-defra-identity" class="md-nav__link">
    <span class="md-ellipsis">
      Onboard with Defra Identity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decide-session-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Decide session setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#understand-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Understand endpoints
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-login" class="md-nav__link">
    <span class="md-ellipsis">
      Implement login
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implement login">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state" class="md-nav__link">
    <span class="md-ellipsis">
      State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nonce-initialisation-vector" class="md-nav__link">
    <span class="md-ellipsis">
      Nonce / Initialisation Vector
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handle-callback-from-defra-identity" class="md-nav__link">
    <span class="md-ellipsis">
      Handle callback from Defra Identity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-user-to-specific-location-after-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Return user to specific location after authentication
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Return user to specific location after authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-authentication-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Set up authentication strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#project-routes" class="md-nav__link">
    <span class="md-ellipsis">
      Project routes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#role-based-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Role based authentication
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Role based authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#azure-api-management" class="md-nav__link">
    <span class="md-ellipsis">
      Azure API Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parsing-siti-agri-response" class="md-nav__link">
    <span class="md-ellipsis">
      Parsing Siti Agri response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updating-credentials" class="md-nav__link">
    <span class="md-ellipsis">
      Updating credentials
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protecting-routes" class="md-nav__link">
    <span class="md-ellipsis">
      Protecting routes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refresh-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      Refresh tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-out" class="md-nav__link">
    <span class="md-ellipsis">
      Sign out
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-service-user-journeys" class="md-nav__link">
    <span class="md-ellipsis">
      Cross service user journeys
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="defra-identity">Defra Identity</h1>
<p>Defra Identity is a service that provides external user authentication and authorisation for Defra services. It is based on the OAuth 2.0 and OpenID Connect standards and is backed by <a href="https://learn.microsoft.com/en-us/azure/active-directory-b2c/overview">Azure B2C</a>.</p>
<p>Defra Identity supports authentication through a <a href="https://www.gov.uk/log-in-register-hmrc-online-services">Government Gateway</a> or Rural Payments account.</p>
<p>FCP services should use Defra Identity with a Rural Payments account.  This is because the majority of users will have one and it is only possible to retrieve customer and land data data if the user is authenticated with a Rural Payments account.</p>
<blockquote>
<p>In the future, <a href="https://www.gov.uk/using-your-gov-uk-one-login">GOV.UK One Login</a> will be available as an authentication method via Defra Identity.  It is expected this will be an opportunity to migrate users from their Rural Payments account to GOV.UK One Login.</p>
<p>Defra Identity only supports external user authentication and cannot be used for internal users.</p>
</blockquote>
<h2 id="credentials">Credentials</h2>
<p>When users sign in with a Rural Payments account, they input their Customer Reference Number (CRN) and password.  </p>
<p>The CRN is a unique identifier for the individual.</p>
<h2 id="permissions">Permissions</h2>
<p>Typically, user data and permissions exist in the Defra Customer service.  However, for Rural Payments accounts, this data is stored in Siti Agri.</p>
<p>Once a user has been authenticated, a service must retrieve this data from Siti Agri via an API call.  A complication of this is that this API cannot retrieve all permissions for an individual, instead it can only retrieve permissions for a specific organisation the person is associated with.</p>
<p>For this reason, FCP journey's should be based around an organisation, rather than an individual.  A typical journey would be:</p>
<ol>
<li>User logs in with their Rural Payments account</li>
<li>User selects an organisation they wish to act on behalf of</li>
<li>Service retrieves permissions for that organisation</li>
<li>User can then perform actions on behalf of that organisation</li>
</ol>
<h2 id="login-page">Login page</h2>
<p>The login page is part of Defra Identity as opposed to the consuming service.  Whenever a user needs to authenticate, the service should redirect the user to the Defra Identity login page.  Once authenticated the user will be redirected back to the service.  More details on how to implement this are below.</p>
<p>The login page can be customised by the Defra Identity team for each consuming service.</p>
<h2 id="organisation-picker">Organisation picker</h2>
<p>To support selection of an organisation, Defra Identity provides an organisation picker.  Similar to the login page, this is owned by Defra Identity and can be customised for each consuming service, however data is limited to SBI, organisation Id, and organisation name.</p>
<p>More details on how to interact with this component are below.</p>
<p>The organisation picker can also be disabled.  This can be useful if no permissions or existing data is required, however, it is expected that the majority of FCP services will require the picker.</p>
<h2 id="authorisation-code-flow">Authorisation Code Flow</h2>
<p>Defra Identity uses the <a href="https://oauth.net/2/grant-types/authorization-code/">Authorisation Code Flow</a> to authenticate users.  This is a secure method of authentication that involves the following steps:</p>
<ol>
<li>User is redirected to the Defra Identity login page</li>
<li>User logs in</li>
<li>User selects an organisation</li>
<li>User is redirected back to the consuming service with an authorisation code</li>
<li>Consuming service exchanges the authorisation code for an access token</li>
<li>Consuming service stores JWT token in session</li>
</ol>
<h2 id="single-sign-on">Single Sign on</h2>
<p>Defra Identity supports single sign on (SSO).  This means that once a user has authenticated with one service, they will not need to re-authenticate with another service until their session expires.  When SSO is enabled, consuming services should still redirect to Defra Identity for authentication, however, the user will not need to enter their credentials.</p>
<p>SSO session is managed through a session cookie on the Defra Identity domain.  The session cookie will expire after 30 minutes without interaction with Defra Identity or if the user closes the browser.</p>
<p>FCP services should be setup to support SSO.</p>
<h2 id="implementing-defra-identity-in-an-fcp-service">Implementing Defra Identity in an FCP service</h2>
<h3 id="example-repository">Example repository</h3>
<p>An example repository has been created to demonstrate how to implement Defra Identity in an FCP service.  The repository can be found <a href="https://github.com/DEFRA/fcp-defra-id-example">in GitHub</a>.</p>
<p>The example repository uses a combination of <code>@hapi/bell</code> and <code>@hapi/cookie</code> to manage the session and authenticate the user.</p>
<p><code>@hapi/bell</code> offers a simple way to authenticate users with Defra Identity and is the recommended approach.  However, this guide will include a more verbose setup to demonstrate the underlying principles.</p>
<h3 id="onboard-with-defra-identity">Onboard with Defra Identity</h3>
<p>Contact the Defra Identity team to onboard your service.</p>
<p>They will provide you with the following information.</p>
<ul>
<li>Client ID</li>
<li>Client Secret</li>
<li>Service ID</li>
<li>Well Known URL</li>
<li>Policy name</li>
</ul>
<blockquote>
<p>all FCP services should use the <code>signupsigninsfi</code> policy to ensure users are authenticated with a Rural Payments account</p>
</blockquote>
<p>During onboarding, you will need to provide Defra Identity with the following information:</p>
<ul>
<li>Redirect URL for each environment (<code>GET</code> endpoint Defra Identity should redirect the user to after authentication and organisation selection)</li>
<li>Sign out URL for each environment (<code>GET</code> endpoint Defra Identity should redirect the user to after sign out)</li>
</ul>
<blockquote>
<p>Note: a <code>localhost</code> and port should also be provided to support local development.  If a URL is not provided to Defra Identity, authentication will not work in that environment.</p>
</blockquote>
<h3 id="decide-session-setup">Decide session setup</h3>
<p>Defra Identity will return a JWT token to the consuming service after authentication.  This token should be stored in FCP service's session.  Teams are free to determine the most appropriate way to manage their session dependent on their use case.</p>
<p>Some potential options are:
- Store the JWT in a session cookie
- Store the JWT in a session store (e.g. Redis) and use a session cookie to reference the session store</p>
<p>FCP services must provide a mechanism to clear the session when the user logs out.</p>
<p>FCP services must automatically end the session if the user closes the browser.</p>
<p>For simplicity, this guide will assume <a href="https://www.npmjs.com/package/@hapi/yar"><code>@hapi/yar</code></a> is used to manage the overall session, whilst the JWT token is stored in a separate session cookie.</p>
<h3 id="understand-endpoints">Understand endpoints</h3>
<p>The Well Known URL provided by Defra Identity will provide details of all endpoints in JSON format.  Services can use this to programmatically interact with Defra Identity.</p>
<p>The most important endpoints are:
- <code>authorization_endpoint</code> - URL to redirect the user to for authentication
- <code>token_endpoint</code> - URL to exchange the authorisation code for an access token
- <code>end_session_endpoint</code> - URL to redirect the user to after sign out
- <code>jwks_uri</code> - URL to retrieve the public key to verify the JWT token</p>
<h3 id="implement-login">Implement login</h3>
<p>When a user needs to authenticate, the service should redirect the user to the <code>authorization_endpoint</code>.</p>
<p>This redirection should include teh following query parameters:</p>
<ul>
<li><code>p</code> - the policy name provided by Defra Identity</li>
<li><code>client_id</code> - the client ID provided by Defra Identity</li>
<li><code>service_id</code> - the service ID provided by Defra Identity</li>
<li><code>state</code> - value to maintain state between the request and the callback as well as protect against CSRF attacks (see below)</li>
<li><code>nonce</code> - value to protect against token replay attacks (see below)</li>
<li><code>redirect_uri</code> - the URL to redirect the user to after authentication</li>
<li><code>scope</code> - always set to <code>openid offline_access</code></li>
<li><code>response_type</code> - always set to <code>code</code></li>
<li><code>response_mode</code> - always set to <code>query</code></li>
<li><code>forceReselection</code> - optional parameter to force the user to reselect an organisation on the picker page, even if they have already selected one previously</li>
<li><code>relationshipId</code> - optional parameter to preselect an organisation and skip the picker page.  This must be an Organisation Id from Rural Payments</li>
<li><code>prompt</code> - optional parameter to force the user to reauthenticate if set to true.</li>
</ul>
<p>Once the user has authenticated and selected an organisation, they will be redirected back to the service with an authorisation code in the query parameters.  The code can then be exchanged for an access token via the <code>token_endpoint</code>.</p>
<h4 id="state">State</h4>
<p>The <code>state</code> parameter is used to maintain state between the request and the callback.  This is important to protect against CSRF attacks.  The service should generate a random value for each request and store it in the session.  The value should be included in the request to Defra Identity and checked against the value in the session when the user is redirected back to the service.</p>
<p>The <code>state</code> parameter is a <code>base64</code> encoded string.</p>
<p>An example of how to generate the <code>state</code> parameter using the <a href="https://www.npmjs.com/package/uuid"><code>uuid</code></a> npm package is below:</p>
<pre><code class="language-javascript">const state = Buffer.from(JSON.stringify({
  id: uuidv4(), // Unique identifier for the request
})).toString('base64')

request.yar.set('state', state)
</code></pre>
<h4 id="nonce-initialisation-vector">Nonce / Initialisation Vector</h4>
<p>The <code>nonce</code> parameter is used to protect against token replay attacks.  The service should generate a random value for each request and store it in the session.  The value should be included in the request to Defra Identity and checked against the value in the session when the user is redirected back to the service.</p>
<p>As a random value is used, the term <code>nonce</code> is not strictly accurate and "Initialisation Vector" is a more accurate description.</p>
<p>Unlike the state which is returned direct from Defra Identity, the nonce is included in the final JWT token.</p>
<p>An example of how to generate the <code>nonce</code> parameter using the <a href="https://www.npmjs.com/package/uuid"><code>uuid</code></a> npm package is below:</p>
<pre><code class="language-javascript">const initialisationVector = uuidv4()

request.yar.set('initialisationVector', initialisationVector)
</code></pre>
<h3 id="handle-callback-from-defra-identity">Handle callback from Defra Identity</h3>
<p>Once the user has authenticated and selected an organisation, they will be redirected back to the service with an authorisation code in the query parameters.</p>
<p>The service should validate the <code>state</code> property and exchange the authorisation code for an access token via the <code>token_endpoint</code>.</p>
<p>Once the token is retrieved, the <code>nonce</code> property should be validated and the token stored in session state.</p>
<pre><code class="language-javascript">// redirect route from Defra Identity
server.route({
  method: 'GET',
  path: '/sign-in-oidc',
  handler: async (request, h) =&gt; {
    const { code, state } = request.query

    // validate state
    const sessionStateId = request.yar.get('state')
    const { id } = JSON.parse(Buffer.from(state, 'base64').toString())

    if (id !== sessionStateId) {
      throw new Error('Invalid state, possible CSRF attack')
    }

    // get token
    const { payload } = await Wreck.post(`${token_endpoint}?client_id=${clientId}&amp;client_secret=${clientSecret}&amp;code=${code}&amp;grant_type=authorization_code&amp;redirect_uri=${redirectUri}`, {
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      json: true
    })

    const { access_token } = payload

    // validate initialisation vector
    const sessionInitialisationVector = request.yar.get('initialisationVector')
    const { nonce } = JSON.parse(Buffer.from(access_token.split('.')[1], 'base64').toString())

    if (nonce !== sessionInitialisationVector) {
      throw new Error('Invalid Initialisation Vector, possible token replay attack')
    }

    // store token in session cookie and redirect user to root
    return h.redirect('/').state('auth_cookie', access_token, {
      ttl: null // session cookie
      encoding: 'none', // JWT is already encoded
      isSameSite: 'Lax',
      isSecure: true, // for local development, set to false
      isHttpOnly: true,
      clearInvalid: false,
      strictHeader: true,
      path: '/' // ensure cookie is available on all routes
    })
  }
})
</code></pre>
<h3 id="return-user-to-specific-location-after-authentication">Return user to specific location after authentication</h3>
<p>The <code>state</code> can also be used to store additional information such as where to redirect the user to once they have authenticated.  This strategy avoids users ending up in an unexpected fixed location after authentication after moving between services, or clicking links to specific locations.</p>
<p>If using <a href="https://hapi.dev/">Hapi.js</a>, the user's intended destination can be taken from the <code>request.url.pathname</code> property and stored in the <code>state</code> parameter.  Once authentication is complete, the user can be redirected back to the intended destination.</p>
<h4 id="example">Example</h4>
<p>User tries to access <code>/my-account</code> but is not authenticated.  The service catches a <code>401</code> error and redirects the user to <code>/sign-in</code> with a query parameter taken from their intended destination.</p>
<pre><code class="language-javascript">// plugin to handle 401 errors
server.ext('onPreResponse', (request, h) =&gt; {
  if (request.response.isBoom &amp;&amp; request.response.output.statusCode === 401) {
    return h.redirect(`/sign-in?redirect=${request.url.pathname}`)
  }
  return h.continue
})
</code></pre>
<pre><code class="language-javascript">// sign-in route
server.route({
  method: 'GET',
  path: '/sign-in',
  handler: async (request, h) =&gt; {
    const state = Buffer.from(JSON.stringify({
      id: uuidv4(), // Unique identifier for the request
      redirect: request.query.redirect, // Intended destination
    })).toString('base64')

    request.yar.set('state', state)

    return h.redirect(`https://${defraIdentity}?p=${policy}&amp;client_id=${clientId}&amp;service_id=${serviceId}&amp;state=${state}&amp;redirect_uri=${redirectUri}&amp;scope=openid%20offline_access&amp;response_type=code&amp;response_mode=query`)
  }
})
</code></pre>
<pre><code class="language-javascript">// redirect route from Defra Identity
server.route({
  method: 'GET',
  path: '/sign-in-oidc',
  handler: async (request, h) =&gt; {
    const { code, state } = request.query

    // validation of state and token exchange omitted

    const { redirect } = JSON.parse(Buffer.from(state, 'base64').toString())

    return h.redirect(redirect) // setting of cookie omitted
  }
})
</code></pre>
<h3 id="set-up-authentication-strategy">Set up authentication strategy</h3>
<p>A Hapi.js plugin can be used to setup an appropriate authentication strategy.  This plugin should be registered with the server and can be used to protect routes that require authentication.</p>
<p>For example, if storing the JWT in a session cookie, the plugin could utilise the <code>@hapi/cookie</code> or <code>hapi-auth-jwt2</code> plugins.</p>
<p>The below example uses the <code>hapi-auth-jwt2</code> plugin to validate the JWT token.</p>
<pre><code class="language-javascript">await server.register(require('hapi-auth-jwt2'))
await server.register({
  plugin: {
    name: 'auth',
    register: async (server, options) =&gt; {
      server.auth.strategy('jwt', 'jwt', {
        key: async () =&gt; {
          const { payload } = await Wreck.get(jwks_uri, {
            json: true
          }) // get public key from Defra Identity, `jwks_uri` is part of well known URL

          const { keys } = payload
          const pem = jwkToPem(keys[0]) // convert to pem format
          return { key: pem }
        },
        validate: async (decoded, request, h) =&gt; {
          // validate the decoded token
          return { isValid: true, credentials: { name: `${decoded.firstName} ${decoded.lastName}` } }
        },
        verifyOptions: {
          algorithms: ['RS256']
        }
      })

      server.auth.default({ strategy: 'jwt', mode: 'try' }) // try will attempt to authenticate but not fail if not authenticated.  This allows all routes to have access to the credentials object
    }
  }
})
</code></pre>
<h3 id="project-routes">Project routes</h3>
<p>If a <code>try</code> authentication strategy is used then all routes will attempt to authenticate the user but not fail if not authenticated.  This allows the service to determine if the user is authenticated and act accordingly.</p>
<p>If a route requires authentication, then mode can be set to <code>required</code>.  A <code>401</code> error will be thrown if the user is not authenticated.  Catching a <code>401</code> error and redirecting the user to the sign in page is a common pattern.</p>
<pre><code class="language-javascript">// route that requires authentication
server.route({
  method: 'GET',
  path: '/my-account',
  options: {
    auth: {
      strategy: 'jwt',
      mode: 'required'
    }
  },
  handler: async (request, h) =&gt; {
    return h.response('My account')
  }
})
</code></pre>
<p>If no authentication is required, then authentication can be set to false.  For example, the sign in route should be accessible at all times.</p>
<pre><code class="language-javascript">// route that does not require authentication
server.route({
  method: 'GET',
  path: '/public',
  options: {
    auth: false
  },
  handler: async (request, h) =&gt; {
    return h.response('Public')
  }
})
</code></pre>
<h3 id="role-based-authentication">Role based authentication</h3>
<p>Typically as well as ensuring the user is authenticated, services will also want to ensure the user has the correct permissions to access a route.  For services using Government Gateway, the JWT token will contain the user's permissions for the selected organisation.</p>
<p>However, for services using Rural Payments, the JWT token will not contain the user's permissions.  Instead, the service will need to retrieve the permissions from Siti Agri via an API call.</p>
<h4 id="azure-api-management">Azure API Management</h4>
<p>Unlike FCP services that are hosted in Azure, Siti Agri is deployed to Crown Hosting.  Connectivity from Azure to Crown Hosting is only possible through an Azure API Management (APIM) service</p>
<p>An endpoint has been made available through APIM to access this API from FCP services running in Azure Kubernetes Service.</p>
<p><code>https://&lt;ENVIRONMENT&gt;/rural-payments-vet-visits/v1/SitiAgriApi/authorisation/organisation/&lt;ORGANISATION_ID&gt;/authorisation</code></p>
<p>The endpoint requires the following headers:</p>
<ul>
<li><code>crn</code> - the user's Customer Reference Number</li>
<li><code>X-Forwarded-Authorization</code> - the JWT token</li>
<li><code>Authorization</code> - a <code>Bearer</code> token from APIM</li>
<li><code>Ocp-Apim-Subscription-Key</code> - the subscription key for the APIM service</li>
</ul>
<p>Before the endpoint can be called, the service must first authenticate with APIM.  This is done by calling the following endpoint:</p>
<p><code>https://login.microsoftonline.com/&lt;TENANT&gt;/oauth2/v2.0/token</code></p>
<p>This endpoint requires a <code>form-data</code> type POST request with query parameters.</p>
<p>The following parameters are common to all FCP services and can be found in Azure Key Vault</p>
<ul>
<li>clientId</li>
<li>clientSecret</li>
<li>scope</li>
</ul>
<p>Example using <a href="https://www.npmjs.com/package/@hapi/wreck"><code>@hapi/wreck</code></a>:</p>
<pre><code class="language-javascript">const Wreck = require('@hapi/wreck')
const FormData = require('form-data')

  const data = new FormData()
  data.append('client_id', `${clientId}`)
  data.append('client_secret', `${clientSecret}`)
  data.append('scope', `${scope}`)
  data.append('grant_type', 'client_credentials')

  return Wreck.post(apimConfig.authorizationUrl, {
    headers: data.getHeaders(),
    payload: data,
    json: true
  })
</code></pre>
<h4 id="parsing-siti-agri-response">Parsing Siti Agri response</h4>
<p>Siti Agri will return a response containing all roles and permissions for all users associated with the business.  The service must parse this response to determine if the user has the correct permissions.</p>
<p>Example response:</p>
<pre><code class="language-json">{
  &quot;data&quot;: {
    &quot;personRoles&quot;: [{
      &quot;personId&quot;: 1000001,
      &quot;role&quot;: &quot;Farmer&quot;
    }, {
      &quot;personId&quot;: 1000002,
      &quot;role&quot;: &quot;Agent&quot;
    }],
    &quot;personPrivileges&quot;: [{
      &quot;personId&quot;: 1000001,
      &quot;privilege&quot;: &quot;View&quot;
    }, {
      &quot;personId&quot;: 1000001,
      &quot;privilege&quot;: &quot;Edit&quot;
    }, {
      &quot;personId&quot;: 1000002,
      &quot;privilege&quot;: &quot;Edit&quot;
    }]
  }
}
</code></pre>
<p>A complexity of this is that all permissions are returned, not just for the logged in user.  The service must filter the response based on <code>personId</code>.  <code>personId</code> is not included in the JWT token and must be retrieved from a separate APIM endpoint.</p>
<p><code>https://&lt;ENVIRONMENT&gt;/rural-payments-vet-visits/v1/person/3337243/summary</code></p>
<blockquote>
<p>Note: <code>3337243</code> is a fixed value and does not need to be changed.</p>
</blockquote>
<p>The endpoint requires the following headers:</p>
<ul>
<li><code>crn</code> - the user's Customer Reference Number</li>
<li><code>X-Forwarded-Authorization</code> - the JWT token</li>
<li><code>Authorization</code> - a <code>Bearer</code> token from APIM</li>
<li><code>Ocp-Apim-Subscription-Key</code> - the subscription key for the APIM service</li>
</ul>
<p>Example flow:</p>
<ol>
<li>User logs in with their Rural Payments account</li>
<li>User selects an organisation</li>
<li>Service retrieves organisation Id from <code>currentRelationshipId</code> property in JWT token</li>
<li>Service retrieves <code>personId</code> via APIM</li>
<li>Service retrieves permissions from Siti Agri via APIM</li>
<li>Service filters permissions based on <code>personId</code></li>
<li>Service persists permissions in session</li>
</ol>
<h4 id="updating-credentials">Updating credentials</h4>
<p>The roles should be stored in the <code>scope</code> property of <code>credentials</code> during authentication.  As the JWT does not include the roles, they must be added to the <code>credentials</code> object during each request.</p>
<pre><code class="language-javascript">validate: async (decoded, request, h) =&gt; {
  // get roles already retrieved from Siti Agri from session
  const roles = request.yar.get('roles') // must be array
  return { isValid: true, credentials: { name: `${decoded.firstName} ${decoded.lastName}`, scope: roles } }
},
</code></pre>
<h4 id="protecting-routes">Protecting routes</h4>
<p>Once a role has been mapped to a service specific role, the service can protect routes by using the <code>scope</code> property.</p>
<p>If the user does not have the correct role, a <code>403</code> error will be thrown and the user will not be able to access the route.  Services can catch this error and redirect the user to an appropriate page.</p>
<pre><code class="language-javascript">// route that requires authentication and a specific role
server.route({
  method: 'GET',
  path: '/my-account',
  options: {
    auth: {
      strategy: 'jwt',
      scope: ['View'] // role required to access route
    }
  },
  handler: async (request, h) =&gt; {
    return h.response('My account')
  }
})
</code></pre>
<h3 id="refresh-tokens">Refresh tokens</h3>
<p>Defra Identity will also return a Refresh Token when the user authenticates.  This token can be used to obtain a new Access Token when the current Access Token expires.</p>
<p>The Refresh Token should also be stored in session storage, however due to it's size, it's recommended to store it in a session store (e.g. Redis).</p>
<p>Libraries such as <code>hapi-auth-jwt2</code> and <code>@hapi/cookie</code> do not support Refresh Tokens out of the box.  The service will need to implement this functionality manually.  By default, both of these libraries will fail validation if the token is expired.  This behaviour can be disabled if the service wishes to refresh the token before or after it expires.</p>
<h3 id="sign-out">Sign out</h3>
<p>When a user signs out, the service should redirect the user to the <code>end_session_endpoint</code>.  This will clear the session cookie on the Defra Identity domain and the user will be signed out.</p>
<p>Similar to the login page, the user will be redirected back to the service after sign out.  The service should clear the session cookie and any other session data at this point.</p>
<h3 id="cross-service-user-journeys">Cross service user journeys</h3>
<p>As FCP grows in scale, it is expected that users will need to move between services within the same session.  We do not want users to have to re-authenticate or re-select an organisation when moving between services.</p>
<p>Services should therefore be designed so that an <code>organisationId</code> can be passed to any route as a query string.  The service will then pass this to Defra Identity as the <code>relationshipId</code> parameter during the first login process which will mean the picker page is skipped.</p>
<p>If the user has an active session in Defra Identity, the user will automatically not be asked for credentials.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>